<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Pedidos</title>
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/personalizado.css">
    
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const entregar = (id) => {
          fetch(`/pedidos_lista/entregar/${id}`, { method: 'PUT' }).then(() => {
          window.location.reload()
        });
      }

      const simularPagamento = (id) => {
        fetch(`/pedidos_lista/${id}`, { method: 'PUT' }).then(() => {
          window.location.reload()
        });
      }
    </script>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="d-flex">
      <%- include('partials/sidebar', { user: user }) %>
      <%- include('partials/logout') %>

      <!--  Tabela de Pedidos -->
      <div class="card shadow p-4 mb-4 w-100">
        <h2 class="mb-3">Lista de Pedidos</h2>

        <!--  Filtro de cliente -->
        <select id="filtroCliente" class="form-select w-auto mb-3">
          <option value="">Selecione um Cliente</option>
          <% clientes.map(c => { %>
            <option value="<%= c.id %>"><%= c.nome %></option>
          <% }) %>
        </select>

        <% if (pedidos && pedidos.length > 0) { %>
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th></th>
              <th>ID</th>
                <th>Entrega</th>
              <th>Cliente</th>
              <th>Contato</th>
              <th>Data</th>
              <th>Total (R$)</th>
              <th>M茅todo</th>
              <th>Status</th>
            
              <th>Produtos</th>
              <th>Pagamento</th>
            </tr>
          </thead>
          <tbody>
            <% pedidos.forEach(pedido => { %>
            <tr>
              <td>
                <% if (!pedido.codigoPix) { %>
                  <input type="checkbox" class="pedido-checkbox" value="<%= pedido.id %>">
                <% } %>
              </td>
              <td><%= pedido.id %></td>
             <td>
              <% if (!pedido.entrega) { %>
                <button onclick="entregar(<%= pedido.id %>)" class="btn btn-success btn-sm">
                  Marcar como entregue
                </button>
              <% } else { %>
                Entregue
              <% } %>
            </td>


              <td><%= pedido.cliente_nome %></td>
              <td><%= pedido.cliente_contato %></td>
              <td><%= new Date(pedido.data).toLocaleDateString('pt-BR') %></td>
              <td>R$ <%= (pedido.total / 100).toFixed(2) %></td>
              <td><%= pedido.metodo %></td>
              <td><%= pedido.status %></td>
          
              <td>
                <% pedido?.produtos.forEach(prod => { %>
                  <span class="badge bg-secondary"><%= prod %></span>
                <% }) %>
              </td>
              <td>
                <% if (pedido?.codigoPix ) { %>
                  <button class="btn btn-success btn-sm abir-pagamento"
                    data-pedido='<%= JSON.stringify(pedido) %>'>
                     Abrir Pagamento
                  </button>

                  <button class="btn btn-success btn-sm"
                    onclick="simularPagamento('<%= pedido.idPix %>')">
                     Simular Pagamento
                  </button>
                <% } else { %>
                  <button class="btn btn-success btn-sm gerar-pagamento"
                    data-pedido='<%= JSON.stringify(pedido) %>'>
                     Gerar Link
                  </button>
                <% } %>
              </td>
            </tr>
            <% }) %>
          </tbody>
        </table>
        <% } else { %>
          <p>Nenhum pedido encontrado.</p>
        <% } %>

        <div class="mt-3 d-flex gap-2">
          <a href="/pedidos" class="btn btn-primary">Novo Pedido</a>
          <button id="gerarGrupo" class="btn btn-success"> Gerar Pagamento em Grupo</button>
        </div>
      </div>
    </div>

    <!--  Modal PIX -->
    <div class="modal fade" id="pixModal" tabindex="-1" aria-labelledby="pixModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="pixModalLabel">Pagamento PIX</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body text-center">
            <p><strong>C贸digo PIX:</strong></p>
            <textarea id="pixCodigo" class="form-control mb-2" rows="3" readonly></textarea>
            <button class="btn btn-outline-primary mb-3" id="copiarCodigo">Copiar C贸digo</button>
            <div>
              <p><strong>QR Code:</strong></p>
              <img id="pixQRCode" src="" alt="QR Code PIX" class="img-fluid" />
            </div>
            <button class="btn btn-outline-success mt-2" id="baixarQRCode">Baixar QR Code</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      //  Filtro de cliente
      document.getElementById('filtroCliente').addEventListener('change', (e) => {
        const clienteId = e.target.value;
        if (!isNaN(clienteId)) {
          window.location.href = `/pedidos_lista/${clienteId}`;
       
        } 
      });

      //  Abrir pagamento existente
      document.querySelectorAll('.abir-pagamento').forEach(btn => {
        btn.addEventListener('click', async () => {
          const pedido = JSON.parse(btn.dataset.pedido);
          if (pedido?.codigoPix && pedido?.qrCode) {
            document.getElementById('pixCodigo').value = pedido.codigoPix;
            document.getElementById('pixQRCode').src = pedido.qrCode;

            document.getElementById('copiarCodigo').onclick = () => {
              navigator.clipboard.writeText(pedido.codigoPix).then(() => alert("C贸digo PIX copiado!"));
            };

            document.getElementById('baixarQRCode').onclick = () => {
              const a = document.createElement('a');
              a.href = pedido.qrCode;
              a.download = `pix_${pedido.id}.png`;
              a.click();
            };

            const modal = new bootstrap.Modal(document.getElementById('pixModal'));
            modal.show();
          } else {
            alert("Erro: dados do PIX n茫o retornados pelo servidor.");
          }
        });
      });
      document.querySelectorAll('.gerar-pagamento').forEach(btn => {
        btn.addEventListener('click', async () => {
          const pedido = btn.dataset.pedido;
          try {
            const res = await fetch("/pedidos_lista", {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ pedido })
            });

            const data = await res.json();
            if (data?.codigo && data?.qrCode) {
              document.getElementById('pixCodigo').value = data.codigo;
              document.getElementById('pixQRCode').src = data.qrCode;

              document.getElementById('copiarCodigo').onclick = () => {
                navigator.clipboard.writeText(data.codigo).then(() => alert("C贸digo PIX copiado!"));
              };

              document.getElementById('baixarQRCode').onclick = () => {
                const a = document.createElement('a');
                a.href = data.qrCode;
                a.download = `pix_${pedido.id}.png`;
                a.click();
              };

              const modal = new bootstrap.Modal(document.getElementById('pixModal'));
              modal.show();
            } else {
              window.location.reload()
            }
          } catch (err) {
            console.error("Erro ao gerar link:", err);
            alert("Falha ao gerar link de pagamento.");
          }
        });
      });

      document.getElementById('gerarGrupo').addEventListener('click', async () => {
        const selecionados = Array.from(document.querySelectorAll('.pedido-checkbox:checked')).map(cb => cb.value);

        if (selecionados.length === 0) {
          alert("Selecione ao menos um pedido pendente.");
          return;
        }

        if (!confirm(`Gerar pagamento para ${selecionados.length} pedido(s)?`)) return;

        try {
          const res = await fetch("/pedidos_lista/grupo", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pedidos: selecionados })
          });

          const data = await res.json();

          if (data?.codigo && data?.qrCode) {
            document.getElementById('pixCodigo').value = data.codigo;
            document.getElementById('pixQRCode').src = data.qrCode;

            document.getElementById('copiarCodigo').onclick = () => {
              navigator.clipboard.writeText(data.codigo).then(() => alert("C贸digo PIX copiado!"));
            };

            document.getElementById('baixarQRCode').onclick = () => {
              const a = document.createElement('a');
              a.href = data.qrCode;
              a.download = `pix_grupo.png`;
              a.click();
            };

            const modal = new bootstrap.Modal(document.getElementById('pixModal'));
            modal.show();
          } else {
            alert("Erro ao gerar pagamento em grupo.");
          }
        } catch (err) {
          console.error(err);
          alert("Falha ao gerar pagamento em grupo.");
        }
      });
    </script>
  </body>
</html>

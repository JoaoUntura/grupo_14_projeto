<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Carteira</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>

  <body>
    <div class="d-flex">
      <!-- Sidebar -->
      <%- include('partials/sidebar') %>
      <!-- Conteúdo principal -->
      <div class="container-fluid p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="brand">Sabor do Campo - Carteira</h3>
        </div>

        <!-- Informações da Loja -->
        <div class="card shadow p-4 mb-4">
          <h4>Informações da Loja</h4>
          <p><strong>Nome:</strong> <%= lojaInfo.name %></p>
       
          <div class="row">
            <div class="col-md-4"><strong>Disponível:</strong> R$ <%= (lojaInfo.balance.available / 100).toFixed(2) %></div>
            <div class="col-md-4"><strong>Pendente:</strong> R$ <%= (lojaInfo.balance.pending / 100).toFixed(2) %></div>
            <div class="col-md-4"><strong>Bloqueado:</strong> R$ <%= (lojaInfo.balance.blocked / 100).toFixed(2) %></div>
          </div>
        </div>

        <!-- Lista de Saques -->
        <div class="card shadow p-4 mb-4">
          <h4 class="mb-3">Saques</h4>

          <% if (saques && saques.length > 0) { %>
            <table class="table table-bordered">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Valor (R$)</th>
                  <th>Status</th>
                  <th>Recibo</th>
                  <th>Criado em</th>
                </tr>
              </thead>
              <tbody>
                <% saques.forEach(saque => { %>
                  <tr>
                    <td><%= saque.id %></td>
                    <td>R$ <%= (saque.amount / 100).toFixed(2) %></td>
                    <td><%= saque.status %></td>
                    <td>
                      <% if (saque.receiptUrl) { %>
                        <a href="<%= saque.receiptUrl %>" target="_blank">Visualizar</a>
                      <% } else { %>
                        N/A
                      <% } %>
                    </td>
                    <td><%= new Date(saque.createdAt).toLocaleDateString('pt-BR') %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } else { %>
            <p>Nenhum saque registrado.</p>
          <% } %>
        </div>

        <!-- Novo Saque -->
        <div class="card shadow p-4 mb-4">
          <h4>Criar Novo Saque</h4>
          <form id="form-saque">
            <div class="mb-3">
              <label for="valorSaque" class="form-label">Valor (R$)</label>
              <input type="number" class="form-control" id="valorSaque" min="1" step="0.01" required />
            </div>
            <button type="submit" class="btn btn-primary">Solicitar Saque</button>
          </form>
        </div>
      </div>
    </div>

    <script>
      const formSaque = document.getElementById('form-saque');
      formSaque.addEventListener('submit', async (e) => {
        e.preventDefault();
        const valor = parseFloat(document.getElementById('valorSaque').value);

        if (isNaN(valor) || valor <= 0) {
          alert("Informe um valor válido.");
          return;
        }

        try {
          const res = await fetch('/carteira', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount: Math.round(valor * 100) }) // enviar em centavos
          });

          const data = await res.json();

          if (data?.success) {
            alert("Saque solicitado com sucesso!");
            location.reload(); // recarrega a página para atualizar a lista
          } else {
            alert("Erro ao solicitar saque: " + (data?.message || ''));
          }
        } catch (err) {
          console.error(err);
          alert("Falha ao solicitar saque.");
        }
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carteira</title>
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/personalizado.css">

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>

  <body>
    <div class="d-flex">
      <%- include('partials/sidebar', { user: user }) %>
      
      <div class="pagina-conteudo">
        <%- include('partials/logout') %>

        <div class="main-card-wrapper">
          
          <h2 class="page-title">Carteira</h2>
          
          <div class="content-card">
            
            <div class="inner-card">
              <h5 class="card-title-header">Informações da Loja</h5>
              <p><strong>Nome:</strong> <%= lojaInfo.name %></p>
            
              <div class="info-row">
                <div class="info-item"><span class="label">Disponível:</span> R$ <%= (lojaInfo.balance.available / 100).toFixed(2) %></div>
                <div class="info-item"><span class="label">Pendente:</span> R$ <%= (lojaInfo.balance.pending / 100).toFixed(2) %></div>
                <div class="info-item"><span class="label">Bloqueado:</span> R$ <%= (lojaInfo.balance.blocked / 100).toFixed(2) %></div>
              </div>
            </div>

            <div class="inner-card">
              <h5 class="card-title-header">Saques</h5>
              <table class="table table-striped custom-table">
                <thead>
                  <tr>
                    <th>Valor</th>
                    <th>Data</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (lojaInfo.withdrawals && lojaInfo.withdrawals.length > 0) { %>
                    <% lojaInfo.withdrawals.forEach(withdrawal => { %>
                      <tr>
                        <td>R$ <%= (withdrawal.amount / 100).toFixed(2) %></td>
                        <td><%= new Date(withdrawal.created_at).toLocaleDateString('pt-BR') %></td>
                        <td><%= withdrawal.status %></td>
                      </tr>
                    <% }); %>
                  <% } else { %>
                    <tr>
                      <td colspan="3">Nenhum saque registrado.</td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
            
            <div class="inner-card">
              <h5 class="card-title-header">Criar Novo Saque</h5>
              <form id="form-saque">
                <div class="mb-3">
                  <label for="valorSaque" class="form-label custom-label">Valor (R$)</label>
                  <input type="number" class="custom-input" id="valorSaque" min="1" step="0.01" required />
                </div>
                <button type="submit" class="custom-button">Solicitar Saque</button>
              </form>
            </div>
          </div>

        </div> </div> </div> <script>
      // ... (Mantenha o script existente aqui) ...
      const formSaque = document.getElementById('form-saque');
      formSaque.addEventListener('submit', async (e) => {
        e.preventDefault();
        const valor = parseFloat(document.getElementById('valorSaque').value);

        if (isNaN(valor) || valor <= 0) {
          alert("Informe um valor válido.");
          return;
        }

        try {
          const res = await fetch('/carteira', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount: Math.round(valor * 100) }) // enviar em centavos
          });

          const data = await res.json();

          if (data?.success) {
            alert("Saque solicitado com sucesso!");
            location.reload(); // recarrega a página para atualizar a lista
          } else {
            alert("Erro ao solicitar saque: " + (data?.message || ''));
          }
        } catch (error) {
          alert('Erro na comunicação com o servidor.');
        }
      });
    </script>
  </body>
</html>